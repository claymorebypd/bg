<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .drop-zone {
            border: 2px dashed #e2e8f0;
            transition: border-color 0.2s ease-in-out;
        }

        .drop-zone.dragover {
            border-color: #38a169;
        }

        #loading-indicator, #resize-loading-indicator {
            border-top-color: #38a169;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-button {
            @apply py-2 px-4 rounded-lg font-medium transition-colors duration-200;
        }
        .nav-button.active {
            @apply bg-green-600 text-white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-4xl w-full text-center border border-gray-100 mb-4">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">AI Image Editor</h1>
        <p class="text-gray-500 mb-6">Tools to edit and prepare your images.</p>

        <!-- Navigation Tabs -->
        <div class="mb-6 flex justify-center space-x-4">
            <button id="remover-tab" class="nav-button active">Background Remover</button>
            <button id="resizer-tab" class="nav-button">Image Resizer</button>
        </div>

        <!-- Background Remover Section -->
        <div id="remover-section" class="space-y-6">
            <div class="text-gray-500 mb-6">Isolate objects and make the background transparent.</div>
            <!-- File Drop Zone -->
            <div id="remover-drop-zone" class="drop-zone flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg cursor-pointer">
                <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-500 font-medium">Drag & drop images here</p>
                <p class="text-gray-400 text-sm">or click to browse</p>
                <input type="file" id="remover-file-input" class="hidden" accept="image/*" multiple>
            </div>

            <!-- Action Buttons and Status -->
            <div class="flex flex-col space-y-4">
                <button id="process-button" class="cta-button bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center justify-center" disabled>
                    <span id="remover-button-text">Remove Background</span>
                    <div id="loading-indicator" class="w-5 h-5 border-2 rounded-full border-solid border-gray-200 ml-2 hidden"></div>
                </button>
                <a id="remover-download-link" class="cta-button bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 hidden" download="transparent_image.png">
                    Download All Images
                </a>
            </div>

            <div id="remover-message-box" class="mt-4 text-sm text-red-500"></div>

            <!-- Image Previews Container -->
            <div id="remover-image-previews" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 hidden"></div>

        </div>

        <!-- Image Resizer Section -->
        <div id="resizer-section" class="space-y-6 hidden">
            <div class="text-gray-500 mb-6">Resize multiple images to a uniform size for your website.</div>
            <div id="resizer-drop-zone" class="drop-zone flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg cursor-pointer">
                <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-500 font-medium">Drag & drop multiple images here</p>
                <p class="text-gray-400 text-sm">or click to browse</p>
                <input type="file" id="resizer-file-input" class="hidden" accept="image/*" multiple>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex flex-col items-start w-full md:w-1/2">
                    <label for="width-input" class="text-sm font-medium text-gray-600 mb-1">Width (px)</label>
                    <input type="number" id="width-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 800" value="800">
                </div>
                <div class="flex flex-col items-start w-full md:w-1/2">
                    <label for="height-input" class="text-sm font-medium text-gray-600 mb-1">Height (px)</label>
                    <input type="number" id="height-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 600" value="600">
                </div>
            </div>

            <button id="resize-button" class="cta-button bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center w-full" disabled>
                <span id="resize-button-text">Resize Images</span>
                <div id="resize-loading-indicator" class="w-5 h-5 border-2 rounded-full border-solid border-gray-200 ml-2 hidden"></div>
            </button>
            <a id="download-all-link" class="cta-button bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 hidden" download="resized_images.zip">
                Download All Resized Images
            </a>

            <div id="resizer-image-previews" class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 hidden"></div>
            <div id="resizer-message-box" class="mt-4 text-sm text-red-500"></div>

        </div>
    </div>
    
    <footer class="mt-8 text-center text-sm text-gray-500">
        &copy; 2025 Bluden AB - Sweden
    </footer>

    <script>
        // DOM Elements
        const removerTab = document.getElementById('remover-tab');
        const resizerTab = document.getElementById('resizer-tab');
        const removerSection = document.getElementById('remover-section');
        const resizerSection = document.getElementById('resizer-section');

        // Background Remover Elements
        const removerDropZone = document.getElementById('remover-drop-zone');
        const removerFileInput = document.getElementById('remover-file-input');
        const removerImagePreviews = document.getElementById('remover-image-previews');
        const processButton = document.getElementById('process-button');
        const removerButtonText = document.getElementById('remover-button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const removerDownloadLink = document.getElementById('remover-download-link');
        const removerMessageBox = document.getElementById('remover-message-box');

        // Image Resizer Elements
        const resizerDropZone = document.getElementById('resizer-drop-zone');
        const resizerFileInput = document.getElementById('resizer-file-input');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const resizeButton = document.getElementById('resize-button');
        const resizeButtonText = document.getElementById('resize-button-text');
        const resizeLoadingIndicator = document.getElementById('resize-loading-indicator');
        const downloadAllLink = document.getElementById('download-all-link');
        const resizerImagePreviews = document.getElementById('resizer-image-previews');
        const resizerMessageBox = document.getElementById('resizer-message-box');
        
        // State
        let uploadedFiles = [];
        let processedImages = [];
        let resizedImageBlobs = [];

        // Helper Functions
        function showMessage(message, type, target) {
            const messageBox = target === 'remover' ? removerMessageBox : resizerMessageBox;
            messageBox.textContent = message;
            messageBox.className = `mt-4 text-sm ${type === 'error' ? 'text-red-500' : 'text-green-500'}`;
        }

        function clearMessages() {
            removerMessageBox.textContent = '';
            resizerMessageBox.textContent = '';
        }

        function showSection(sectionId) {
            clearMessages();
            if (sectionId === 'remover-section') {
                removerSection.classList.remove('hidden');
                resizerSection.classList.add('hidden');
                removerTab.classList.add('active');
                resizerTab.classList.remove('active');
            } else if (sectionId === 'resizer-section') {
                removerSection.classList.add('hidden');
                resizerSection.classList.remove('hidden');
                removerTab.classList.remove('active');
                resizerTab.classList.add('active');
            }
        }

        // Tab Event Listeners
        removerTab.addEventListener('click', () => showSection('remover-section'));
        resizerTab.addEventListener('click', () => showSection('resizer-section'));

        // Drag and Drop Event Handlers for both sections
        function setupDropZone(dropZone, fileInput, multiple) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (multiple) {
                        handleMultipleFilesUpload(files, 'remover');
                    } else {
                        handleSingleFileUpload(files[0]);
                    }
                }
            });
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    if (multiple) {
                        handleMultipleFilesUpload(files, 'remover');
                    } else {
                        handleSingleFileUpload(files[0]);
                    }
                }
            });
        }
        
        function handleMultipleFilesUpload(files, section) {
            uploadedFiles = Array.from(files);
            processedImages = [];
            const previewsContainer = section === 'remover' ? removerImagePreviews : resizerImagePreviews;
            const processBtn = section === 'remover' ? processButton : resizeButton;

            if (uploadedFiles.length === 0) {
                showMessage('No images selected.', 'error', section);
                processBtn.disabled = true;
                return;
            }

            previewsContainer.innerHTML = '';
            previewsContainer.classList.remove('hidden');
            processBtn.disabled = false;
            removerDownloadLink.classList.add('hidden');
            showMessage(`Loaded ${uploadedFiles.length} image(s).`, 'info', section);

            uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgPreviewCard = document.createElement('div');
                    imgPreviewCard.className = 'w-full p-4 bg-gray-100 rounded-lg shadow-inner flex flex-col items-center justify-center space-y-2';
                    imgPreviewCard.innerHTML = `
                        <p class="text-gray-500 font-medium text-center truncate w-full mb-2">${file.name}</p>
                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full">
                            <div class="w-full md:w-1/2">
                                <p class="text-gray-500 text-xs mb-1">Original</p>
                                <img src="${e.target.result}" class="w-full h-auto rounded-md" alt="Original Image">
                            </div>
                            <div class="w-full md:w-1/2">
                                <p class="text-gray-500 text-xs mb-1">Edited</p>
                                <img id="edited-image-${file.name}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23e5e7eb' d='M0 0h24v24H0z'/%3E%3C/svg%3E" class="w-full h-auto rounded-md animate-pulse" alt="Edited Image">
                            </div>
                        </div>
                    `;
                    previewsContainer.appendChild(imgPreviewCard);
                };
                reader.readAsDataURL(file);
            });
        }

        async function removeBackground() {
            if (uploadedFiles.length === 0) {
                showMessage('Please upload images first.', 'error', 'remover');
                return;
            }

            processButton.disabled = true;
            removerButtonText.textContent = 'Processing...';
            loadingIndicator.classList.remove('hidden');
            removerDownloadLink.classList.add('hidden');
            
            showMessage('Processing images...', 'info', 'remover');

            processedImages = [];

            try {
                const processPromises = uploadedFiles.map(async (file) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise(resolve => reader.onloadend = resolve);
                    const base64Data = reader.result.split(',')[1];
                    const prompt = "Isolate the main subject from the image and make the background transparent. Do not include any text or additional elements.";
                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }]
                        }],
                        generationConfig: { responseModalities: ["IMAGE"] }
                    };
                    
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                    const makeApiCallWithBackoff = async (retries = 3, delay = 1000) => {
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (response.status === 429 && retries > 0) {
                                await new Promise(res => setTimeout(res, delay));
                                return makeApiCallWithBackoff(retries - 1, delay * 2);
                            }
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(error.error.message || `API error: ${response.status}`);
                            }
                            return response.json();
                        } catch (error) {
                            if (retries > 0) {
                                await new Promise(res => setTimeout(res, delay));
                                return makeApiCallWithBackoff(retries - 1, delay * 2);
                            } else {
                                throw error;
                            }
                        }
                    };

                    const result = await makeApiCallWithBackoff();
                    const base64DataResult = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (base64DataResult) {
                        const imageUrl = `data:image/png;base64,${base64DataResult}`;
                        const editedImageElement = document.getElementById(`edited-image-${file.name}`);
                        if (editedImageElement) {
                            editedImageElement.src = imageUrl;
                            editedImageElement.classList.remove('animate-pulse');
                        }
                        return { name: file.name, url: imageUrl };
                    }
                    return null;
                });
                
                processedImages = await Promise.all(processPromises);
                processedImages = processedImages.filter(img => img !== null);

                if (processedImages.length > 0) {
                    removerDownloadLink.classList.remove('hidden');
                    showMessage(`Background removed for ${processedImages.length} of ${uploadedFiles.length} images.`, 'success', 'remover');
                } else {
                    showMessage('Failed to process any images. Please try again.', 'error', 'remover');
                }

            } catch (error) {
                console.error(error);
                showMessage(`An error occurred: ${error.message}`, 'error', 'remover');
            } finally {
                processButton.disabled = false;
                removerButtonText.textContent = 'Remove Background';
                loadingIndicator.classList.add('hidden');
            }
        }

        function downloadAllImages() {
            if (processedImages.length === 0) {
                showMessage('No images to download.', 'error', 'remover');
                return;
            }

            processedImages.forEach(image => {
                const a = document.createElement('a');
                a.href = image.url;
                a.download = `transparent_${image.name.replace(/\.[^/.]+$/, "")}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            showMessage('Downloading images...', 'info', 'remover');
        }
        
        // Image Resizer Logic (unchanged)
        function handleSingleFileUpload(file) {
            // This function is for single file uploads, not used in the current multiple file logic.
            // Keeping it for potential future single-file modes.
            console.log('Single file upload handler called.');
        }

        async function resizeImages() {
            if (uploadedFiles.length === 0) {
                showMessage('Please upload images first.', 'error', 'resizer');
                return;
            }

            const width = parseInt(widthInput.value, 10);
            const height = parseInt(heightInput.value, 10);

            if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                showMessage('Please enter valid width and height.', 'error', 'resizer');
                return;
            }

            resizeButton.disabled = true;
            resizeButtonText.textContent = 'Resizing...';
            resizeLoadingIndicator.classList.remove('hidden');
            showMessage('Resizing images...', 'info', 'resizer');
            resizerImagePreviews.classList.remove('hidden');

            resizerImagePreviews.innerHTML = '';
            resizedImageBlobs = [];

            const resizePromises = uploadedFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            canvas.toBlob((blob) => {
                                resizedImageBlobs.push({ blob, fileName: file.name });
                                const imgUrl = URL.createObjectURL(blob);
                                const imgElement = document.createElement('img');
                                imgElement.src = imgUrl;
                                imgElement.className = 'w-full h-auto rounded-md shadow-lg';
                                resizerImagePreviews.appendChild(imgElement);
                                resolve();
                            }, 'image/jpeg', 0.9);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            await Promise.all(resizePromises);
            
            if (resizedImageBlobs.length > 0) {
                downloadAllLink.classList.remove('hidden');
                showMessage('Resizing complete! You can now download the images.', 'success', 'resizer');
            } else {
                showMessage('Failed to resize images. Please try again.', 'error', 'resizer');
            }
            
            resizeButton.disabled = false;
            resizeButtonText.textContent = 'Resize Images';
            resizeLoadingIndicator.classList.add('hidden');
        }

        async function downloadAllResizedImages() {
            if (resizedImageBlobs.length === 0) {
                showMessage('No images to download.', 'error', 'resizer');
                return;
            }

            // Simple download loop, creating and clicking links
            resizedImageBlobs.forEach(item => {
                const url = URL.createObjectURL(item.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resized_${item.fileName}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            showMessage('Downloading images...', 'success', 'resizer');
        }
        
        // Event Listeners
        setupDropZone(removerDropZone, removerFileInput, true);
        setupDropZone(resizerDropZone, resizerFileInput, true);
        processButton.addEventListener('click', removeBackground);
        removerDownloadLink.addEventListener('click', downloadAllImages);
        resizeButton.addEventListener('click', resizeImages);
        downloadAllLink.addEventListener('click', downloadAllResizedImages);

    </script>

</body>
</html>
